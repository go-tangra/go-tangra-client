name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  GO_VERSION: '1.25'

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64

    steps:
      - name: Checkout client
        uses: actions/checkout@v4
        with:
          path: go-tangra-client

      - name: Checkout go-tangra-ipam
        uses: actions/checkout@v4
        with:
          repository: go-tangra/go-tangra-ipam
          path: go-tangra-ipam

      - name: Checkout go-tangra-lcm
        uses: actions/checkout@v4
        with:
          repository: go-tangra/go-tangra-lcm
          path: go-tangra-lcm

      - name: Checkout go-tangra-executor
        uses: actions/checkout@v4
        with:
          repository: go-tangra/go-tangra-executor
          path: go-tangra-executor

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go-tangra-client/go.sum

      - name: Build static binary
        working-directory: go-tangra-client
        env:
          CGO_ENABLED: '0'
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          go build -trimpath \
            -ldflags "-s -w -extldflags '-static' \
              -X main.buildVersion=${VERSION} \
              -X main.commitHash=${COMMIT} \
              -X main.buildDate=${DATE}" \
            -o dist/tangra-client-linux-${{ matrix.goarch }} .

      - name: Install nfpm
        run: |
          go install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest

      - name: Build packages
        working-directory: go-tangra-client
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          export VERSION ARCH

          # nfpm expects dist/tangra-client
          ln -sf tangra-client-linux-${{ matrix.goarch }} dist/tangra-client

          # Build .deb
          envsubst < nfpm.yaml | nfpm package -f /dev/stdin -p deb -t dist/
          # Build .rpm
          envsubst < nfpm.yaml | nfpm package -f /dev/stdin -p rpm -t dist/

          # Remove symlink so it doesn't end up in artifacts
          rm -f dist/tangra-client

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}
          path: go-tangra-client/dist/*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd dist
          sha256sum tangra-client-linux-amd64 tangra-client-linux-arm64 > tangra-client-checksums.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: dist/*
